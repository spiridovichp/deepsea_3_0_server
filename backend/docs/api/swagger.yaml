openapi: 3.0.3
info:
  title: DeepSea 3.0 API
  description: API документация для системы DeepSea 3.0
  version: 3.0.0
servers:
- url: https://api.deepsea.example.com
  description: Production server
- url: http://localhost:8000
  description: Development server
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        messages:
          type: array
          items:
            type: string
    User:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        first_name:
          type: string
          nullable: true
        last_name:
          type: string
          nullable: true
        middle_name:
          type: string
          nullable: true
        department_id:
          type: integer
          nullable: true
        job_title_id:
          type: integer
          nullable: true
        is_active:
          type: boolean
        is_verified:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    Department:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
paths:
  /api/auth/login:
    post:
      tags:
      - auth
      summary: Вход в систему
      description: Аутентификация пользователя и получение токенов доступа
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "admin"
                password:
                  type: string
                  format: password
                  example: "password123"
      responses:
        '200':
          description: Успешный вход в систему
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT токен доступа
                  refresh_token:
                    type: string
                    description: Токен для обновления access токена
                  expires_at:
                    type: string
                    format: date-time
                    description: Время истечения токена
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      username:
                        type: string
                      email:
                        type: string
                      first_name:
                        type: string
                      last_name:
                        type: string
        '400':
          description: Ошибка валидации
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Validation error"
                  messages:
                    type: array
                    items:
                      type: string
                    example: ["Username is required", "Password is required"]
        '401':
          description: Неверные учетные данные
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid credentials"
        '403':
          description: Пользователь деактивирован
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "User account is deactivated"
        '500':
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Internal server error"

  /api/create_users:
    post:
      tags:
        - users
      summary: Создать нового пользователя
      description: Создание нового пользователя в системе
      security:
        - bearerAuth: []
      x-permissions:
        - users.create
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - email
                - phone
                - password
              properties:
                username:
                  type: string
                  maxLength: 100
                  example: "john_doe"
                  description: Уникальное имя пользователя
                email:
                  type: string
                  format: email
                  maxLength: 255
                  example: "john.doe@example.com"
                  description: Email адрес пользователя
                phone:
                  type: string
                  maxLength: 255
                  example: "+1234567890"
                  description: Номер телефона пользователя
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: "password123"
                  description: Пароль пользователя (минимум 6 символов)
      responses:
        '201':
          description: Пользователь успешно создан
        '400':
          description: Ошибка валидации
        '409':
          description: Конфликт - пользователь с такими данными уже существует
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission users.create

  /api/users:
    get:
      tags:
        - users
      summary: Получить список пользователей
      description: Возвращает список пользователей с пагинацией. Требуется разрешение users.view.
      security:
        - bearerAuth: []
      x-permissions:
        - users.view
      parameters:
        - in: query
          name: page
          schema:
            type: integer
          description: Номер страницы (по умолчанию 1)
        - in: query
          name: limit
          schema:
            type: integer
          description: Количество элементов на страницу (по умолчанию 25)
        - in: query
          name: search
          schema:
            type: string
          description: Поиск по username/email/phone (ILIKE)
      responses:
        '200':
          description: Список пользователей
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission users.view
  /api/departments:
    get:
      tags:
        - departments
      summary: Получить список отделов
      description: Возвращает список отделов. Требуется разрешение departments.view.
      security:
        - bearerAuth: []
      x-permissions:
        - departments.view
      responses:
        '200':
          description: Список отделов
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission departments.view
    post:
      tags:
        - departments
      summary: Создать отдел
      description: Создать новый отдел. Требуется разрешение departments.create.
      security:
        - bearerAuth: []
      x-permissions:
        - departments.create
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
      responses:
        '201':
          description: Отдел создан
        '400':
          description: Validation error
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission departments.create
  /api/departments/{id}:
    put:
      tags:
        - departments
      summary: Обновление отдела
      description: Обновляет отдел по ID. Требуется разрешение departments.update.
      security:
        - bearerAuth: []
      x-permissions:
        - departments.update
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID отдела
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
                manager_id:
                  type: integer
      responses:
        '200':
          description: Отдел обновлён
        '400':
          description: Validation error
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission departments.update
        '404':
          description: Department not found
  /api/job-titles:
    get:
      tags:
        - job-titles
      summary: Список должностей
      description: Возвращает список должностей. Требуется разрешение job_titles.view.
      security:
        - bearerAuth: []
      x-permissions:
        - job_titles.view
      responses:
        '200':
          description: Список должностей
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission job_titles.view
    post:
      tags:
        - job-titles
      summary: Создать должность
      description: Создать новую должность. Требуется разрешение job_titles.create.
      security:
        - bearerAuth: []
      x-permissions:
        - job_titles.create
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '201':
          description: Должность создана
        '400':
          description: Validation error
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission job_titles.create
  /api/job-titles/{id}:
    put:
      tags:
        - job-titles
      summary: Обновление должности
      description: Обновление должности по ID. Требуется разрешение job_titles.update.
      security:
        - bearerAuth: []
      x-permissions:
        - job_titles.update
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID должности
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: Должность обновлена
        '400':
          description: Validation error
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission job_titles.update
        '404':
          description: Job title not found
    delete:
      tags:
        - job-titles
      summary: Удаление должности (soft-delete)
      description: Пометить должность как неактивную. Требуется разрешение job_titles.delete.
      security:
        - bearerAuth: []
      x-permissions:
        - job_titles.delete
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID должности
      responses:
        '200':
          description: Job title deleted
        '400':
          description: Invalid id
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission job_titles.delete
        '404':
          description: Job title not found
    delete:
      tags:
        - departments
      summary: Удаление отдела (soft-delete)
      description: Пометить отдел как неактивный. Требуется разрешение departments.delete.
      security:
        - bearerAuth: []
      x-permissions:
        - departments.delete
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID отдела
      responses:
        '200':
          description: Department deleted
        '400':
          description: Invalid department id
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission departments.delete
        '404':
          description: Department not found
  /api/users/{id}:
    get:
      tags:
        - users
      summary: Получить пользователя по ID
      description: Возвращает пользователя по его идентификатору. Требуется разрешение users.view.
      security:
        - bearerAuth: []
      x-permissions:
        - users.view
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID пользователя
      responses:
        '200':
          description: Пользователь найден
        '400':
          description: Invalid user id
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission users.view
        '404':
          description: User not found
    put:
      tags:
        - users
      summary: Обновить пользователя
      description: Частичное обновление пользователя. Требуется разрешение users.update.
      security:
        - bearerAuth: []
      x-permissions:
        - users.update
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                email:
                  type: string
                  format: email
                phone:
                  type: string
                first_name:
                  type: string
                last_name:
                  type: string
                middle_name:
                  type: string
                department_id:
                  type: integer
                job_title_id:
                  type: integer
                is_active:
                  type: boolean
                is_verified:
                  type: boolean
      responses:
        '200':
          description: Пользователь обновлён
        '400':
          description: Invalid user id or bad payload
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission users.update
        '404':
          description: User not found
    delete:
      tags:
        - users
      summary: Удалить пользователя (soft-delete)
      description: Пометить пользователя как неактивного. Требуется разрешение users.delete.
      security:
        - bearerAuth: []
      x-permissions:
        - users.delete
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID пользователя
      responses:
        '200':
          description: User deleted
        '400':
          description: Invalid user id
        '401':
          description: Authentication required
        '403':
          description: Forbidden - missing permission users.delete
        '404':
          description: User not found
  /api/auth/refresh:
    post:
      tags:
        - auth
      summary: Обновить access token
      description: Обновляет access token по refresh token и возвращает новый pair (token, refresh_token)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        '200':
          description: Токены обновлены
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  refresh_token:
                    type: string
                  expires_at:
                    type: string
                    format: date-time
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Неверный refresh token
        '401':
          description: Unauthorized
        '500':
          description: Внутренняя ошибка сервера
  /api/auth/logout:
    post:
      tags:
        - auth
      summary: Выйти из системы (деактивировать сессию)
      description: Деактивирует текущую сессию / refresh token. Требуется авторизация.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logged out
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Authentication required
        '500':
          description: Внутренняя ошибка сервера
  /api/auth/me:
    get:
      tags:
        - auth
      summary: Информация о текущем пользователе
      description: Возвращает профиль авторизованного пользователя.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Профиль пользователя
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Authentication required
